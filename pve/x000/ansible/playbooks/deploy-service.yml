---
# Simplified deployment playbook
# Git pull is handled by host script before calling this playbook
#
# Usage:
#   ansible-playbook deploy-service.yml -e target_host=x202 -e service=caddy
#   ansible-playbook deploy-service.yml -e target_host=x202  # deploys all services
#
- name: Deploy Docker Compose service
  hosts: "{{ target_host | default('all') }}"
  become: true
  gather_facts: false

  vars:
    service_name: "{{ service | default('all') }}"
    base_path: "{{ services_base_path | default('/home/code/docker/config') }}"

  tasks:
    # Pull latest changes before deploying
    - name: Pull latest changes on target
      command: git pull origin main
      args:
        chdir: /home/code/homelab
      register: git_result
      changed_when: "'Already up to date' not in git_result.stdout"

    # Single service deployment
    - name: Deploy single service
      when: service_name != 'all'
      block:
        - name: Check service directory exists
          stat:
            path: "{{ base_path }}/{{ service_name }}"
          register: svc_dir

        - name: Fail if service not found
          fail:
            msg: "Service not found: {{ base_path }}/{{ service_name }}"
          when: not svc_dir.stat.exists

        - name: Pull latest images
          command: docker compose pull
          args:
            chdir: "{{ base_path }}/{{ service_name }}"
          register: pull_result
          changed_when: "'Pulling' in pull_result.stdout or 'Downloaded' in pull_result.stdout"
          ignore_errors: true

        - name: Start service
          command: docker compose up -d --remove-orphans --pull always
          args:
            chdir: "{{ base_path }}/{{ service_name }}"
          register: up_result
          changed_when: "'Started' in up_result.stdout or 'Created' in up_result.stdout or 'Recreated' in up_result.stdout"

        - name: Display service status
          debug:
            msg: "Deployed {{ service_name }} on {{ inventory_hostname }}"

    # All services deployment
    - name: Deploy all services
      when: service_name == 'all'
      block:
        - name: Find all compose files
          find:
            paths: "{{ base_path }}"
            patterns: "compose.yml"
            recurse: true
            depth: 2
          register: compose_files

        - name: Display found services
          debug:
            msg: "Found {{ compose_files.files | length }} services to deploy"

        - name: Deploy each service
          include_tasks: _deploy_single.yml
          loop: "{{ compose_files.files | map(attribute='path') | map('dirname') | list }}"
          loop_control:
            loop_var: svc_path
            label: "{{ svc_path | basename }}"
