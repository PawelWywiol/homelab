---
services:
  webhook:
    container_name: webhook
    build:
      context: .
      dockerfile: Dockerfile
    image: homelab/webhook:latest
    restart: unless-stopped
    ports:
      - "8097:9000"
    volumes:
      - ./hooks.yml:/etc/webhook/hooks.yml:ro
      - ./scripts:/scripts:ro
      # Mount SSH keys with proper permissions
      - ${HOME}/.ssh/ansible_ed25519:/home/webhook/.ssh/id_ed25519:ro
      - ${HOME}/.ssh/known_hosts:/home/webhook/.ssh/known_hosts:ro
    environment:
      - TZ=${TIMEZONE:-Europe/Warsaw}
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET}
      - SSH_HOST=${SSH_HOST:-host.docker.internal}
      - SSH_USER=${SSH_USER:-code}
      - TOFU_AUTO_APPLY=${TOFU_AUTO_APPLY:-false}
      - DISCORD_ENABLED=${DISCORD_ENABLED:-true}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - HOME=/home/webhook
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: ["-verbose", "-hooks=/etc/webhook/hooks.yml", "-hotreload", "-template"]
    networks:
      - homelab
    # Run as host user for security (UID/GID from .env)
    user: "${UID:-1000}:${GID:-1000}"

networks:
  homelab:
    name: homelab
    external: true
