---
# GitHub Webhook Handler - Unified endpoint for homelab automation
# Docs: https://github.com/adnanh/webhook/blob/master/docs/Hook-Definition.md
#
# Architecture: GitHub → Caddy (IP whitelist) → webhook (HMAC) → trigger-homelab.sh → Ansible/OpenTofu
#
# Single unified webhook that routes based on changed files:
#   pve/x202/docker/config/* → Ansible deploy to x202
#   pve/x000/infra/tofu/*    → OpenTofu plan (manual apply)

# Hook: Unified homelab webhook
- id: "homelab"
  execute-command: "/scripts/trigger-homelab.sh"
  command-working-directory: "/scripts"
  pass-arguments-to-command:
    - source: "entire-payload"
  response-message: "Webhook received, processing..."
  trigger-rule:
    and:
      # Security: GitHub signature verification
      - match:
          type: "payload-hmac-sha256"
          secret: "{{ getenv \"GITHUB_WEBHOOK_SECRET\" }}"
          parameter:
            source: "header"
            name: "X-Hub-Signature-256"
      # Repository filter
      - match:
          type: "value"
          value: "PawelWywiol/homelab"
          parameter:
            source: "payload"
            name: "repository.full_name"
      # Branch filter (main only)
      - match:
          type: "value"
          value: "refs/heads/main"
          parameter:
            source: "payload"
            name: "ref"

# Hook: Health check (no auth required)
- id: "health"
  execute-command: "echo"
  pass-arguments-to-command:
    - source: "string"
      name: "OK"
  response-message: "Webhook service healthy"
